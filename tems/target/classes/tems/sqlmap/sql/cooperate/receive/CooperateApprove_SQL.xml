<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="CooperateApproveDAO">

	<select id="CooperateApproveDAO.getCoopApprList" resultClass="tems.com.exam.cooperation.model.CooperationListVO">
		 select
            a.reqid
            ,b.acceptno
            ,c.name comname            
            ,d.name memname              
            ,to_char(b.receiptdate,'yyyy.mm.dd') receiptdate
            ,UFN_GET_ENDDATE(b.receiptdate,TB.itemterm) issuedateplan
            ,TB.itemterm            
            ,TC.smpcnt
            ,TB.rltcnt   
            ,TB.nullcnt 
            ,TB.coopercnt
            ,a.remark            
            ,h.statenm
            ,i.statenm issustatenm
            ,nvl(to_date(to_char(sysdate,'yyyy-mm-dd')) - issuedateplan,0) dday
            ,b.reportid
        from tne_request a
               ,tne_report b
               ,THT_COMPANY c
               ,TNT_MEMBER d
               ,tne_cooper_req e
               ,tct_code_detail f
               ,tct_code_detail g
               ,TCT_STATE h
               ,TCT_APPR_STATE i
               ,(select count(reqid) rltcnt
                           ,sum(case when cooperyn = 'Y' then 1 else 0 end)  coopercnt
                           ,sum(case when resultvalue is not null then 0 else 1 end)  nullcnt
                           ,nvl(max(ITEMTERM),0) itemterm
                           ,reqid 
                    from tne_result  
                    where resultflag = 'Y'
                    and     cooperyn = 'Y'
                  group by reqid 
                ) TB    
               ,(
               	 select reqid, count(smpid) smpcnt from (  
               	   select reqid, smpid from tne_result
	               where cooperyn = 'Y'
	               group by reqid, smpid
	             ) group by reqid           
               ) TC  
        where a.reqid = b.reqid
        and a.comid = c.comid
        and a.ordinal = c.ordinal
        and a.memid = d.memid
        and a.reqid = e.reqid
        and b.pricechargetype = f.CODEID(+)
        and b.pricetype = g.CODEID(+)
        and a.reqid = TB.reqid
        and a.reqid = TC.reqid
        and a.reqstate = h.statecd
        and a.ISSUEAPPR = i.statecd
        and b.type = 'O'
		and e.resultstate = '16' 
		and (e.officeid = (select officeid from tct_admin
                           where adminid = #adminid#) 
	        or 
	         e.officeid = (select uppofficeid from tct_admin
                           where adminid = #adminid#)
	        )       
        <isEqual property="chkstartdate1" compareValue="true">
        <![CDATA[	
        and b.receiptdate >= #startdate1#
        ]]>    
        </isEqual>
	    <isEqual property="chkfinishdate1" compareValue="true">
	    <![CDATA[
        and b.receiptdate <= #finishdate1#
        ]]>    
        </isEqual>
        <isNotEmpty property="firstOpt">
        and a.reqid in (select reqid from tne_sample a, tce_master g ,tce_group h ,tce_class i
						 where a.masterid = g.masterid
						   and g.groupid = h.groupid
						   and h.classid = i.classid
						   and i.classid = #firstOpt#
						   <isNotEmpty property="secondOpt">
					       and h.groupid = #secondOpt#
					       </isNotEmpty>
					       <isNotEmpty property="thirdOpt">
					       and g.masterid = #thirdOpt#
					       </isNotEmpty>
						   )			  
        </isNotEmpty>
        <isNotEmpty property="smpname">
        and a.reqid in (select reqid from tne_sample
						 where name like '%'||#smpname#||'%')
        </isNotEmpty>
        <isNotEmpty property="itemname">
        and a.reqid in (select reqid from tne_result
						 where itemname like '%'||#itemname#||'%')
        </isNotEmpty>
        <isNotEmpty property="acceptno">
        and b.acceptno like '%'||#acceptno#||'%'
        </isNotEmpty>      
        order by to_char(b.receiptdate,'yyyy.mm.dd')  desc 
	</select>
	
	<update id="CooperateApproveDAO.upCoopAppr">
		update tne_cooper_req set 
	        resultstate = '17'
	       ,approveid = #adminid#
	       ,approvedate = sysdate
		where reqid = #reqid#
	</update>
	
</sqlMap>
